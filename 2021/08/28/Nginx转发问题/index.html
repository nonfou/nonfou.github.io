<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=" id=&quot;Nginx转发接口异常，随机出现404-200&quot;&gt;&lt;a href=&quot;#Nginx转发接口异常，随机出现404-200&quot; class=&quot;headerlink&quot; title=&quot;Nginx转发接口异常，随机出现404/200&quot;&gt;&lt;/a&gt;Nginx转发接口异常，随机出现404/200&lt;/h3&gt;&lt;h4 id=&quot;问题&quot;&gt;&lt;a href=&quot;#问题&quot; class=&quot;headerlink&quot; title=&quot;问题&quot;&gt;&lt;/a&gt;问题&lt;/h4&gt;&lt;p&gt;前端nginx部署，后端单体Spring Boot服务"><link rel="stylesheet" href="/css/normalize.css"><link rel="stylesheet" href="/css/highlight.css"><link rel="stylesheet" href="/css/noise.css"><title>Nginx转发问题 | 徐冲的草稿本</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-none-link" href="/tags/Nginx/" rel="tag">Nginx</a></div><div class="post-time">2021-08-28</div></div></div><div class="container post-header"><h1>Nginx转发问题</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E8%BD%AC%E5%8F%91%E6%8E%A5%E5%8F%A3%E5%BC%82%E5%B8%B8%EF%BC%8C%E9%9A%8F%E6%9C%BA%E5%87%BA%E7%8E%B0404-200"><span class="toc-number">1.</span> <span class="toc-text">Nginx转发接口异常，随机出现404&#x2F;200</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%98"><span class="toc-number">1.1.</span> <span class="toc-text">问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%9D%E8%80%83"><span class="toc-number">1.2.</span> <span class="toc-text">思考</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3"><span class="toc-number">1.3.</span> <span class="toc-text">解决</span></a></li></ol></li></ol></details></div><div class="container post-content"><h3 id="Nginx转发接口异常，随机出现404-200"><a href="#Nginx转发接口异常，随机出现404-200" class="headerlink" title="Nginx转发接口异常，随机出现404/200"></a>Nginx转发接口异常，随机出现404/200</h3><h4 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h4><p>前端nginx部署，后端单体Spring Boot服务</p><p>重新部署后，当访问页面时，新添加的模块里的接口有时出现404，有时正常返回200。</p><h4 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h4><p>之前遇到过一个差不多的问题，k8s部署应用时，应用存在多实例的情况，而其中一个实例是比较久的代码打包的，访问接口时就出现有时报错有时正常的情况</p><pre class="mermaid">graph TB
    A[请求] --> B{"Nginx"}
    B -->C["应用实例A"]
    B -->D["应用实例B"]</pre><blockquote><p>新添加的接口只存在应用实例B中，当nginx请求转发到应用实例B中，接口正常返回，当nginx请求转发到应用实例A中，接口表现异常</p></blockquote><p>由此，我想到应该是Nginx转发出现了问题。</p><h4 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h4><p>先查看日志</p><ol><li><p>nginx访问日志出现了502 552的情况</p></li><li><p>nginx错误日志</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">connect() failed (111: Connection refused) while connecting to upstream</span><br></pre></td></tr></table></figure></li></ol><p>应用是单体应用部署，不会是上次遇到的情况。</p><p>搜索了一堆东西……</p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41672878/article/details/108162622">nginx 交替出现404 和200的问题</a></p><p>查看nginx进程</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep nginx</span><br></pre></td></tr></table></figure><p>果然存在多个master进程，保留一个就好了。</p><pre class="mermaid">graph TB
    A[请求] --> B{"Nginx服务器"}
    B -->C["Nginx Master A"]
    B -->D["Nginx Master B"]
    C -->E["应用实例"]
    D -->E</pre><blockquote><p>当接口通过master A转发时，找不到匹配的url，表现在页面就是404</p></blockquote><blockquote><p>当接口通过master B转发时，正确匹配到后端url，表现就是200</p></blockquote></div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function(){$(".fancybox").fancybox()})</script></body></html>